<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>DeviceOrientation + Motion</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
            sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 16px;
        }

        .dashboard {
            width: 100%;
            max-width: 480px;
            background: #020617;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.5);
            border: 1px solid #1f2937;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .header h1 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .header small {
            font-size: 0.7rem;
            color: #9ca3af;
        }

        button#enable-sensors {
            font-size: 0.75rem;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #4b5563;
            background: #111827;
            color: #e5e7eb;
            cursor: pointer;
        }

        button#enable-sensors:active {
            transform: scale(0.98);
        }

        .row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: stretch;
        }

        .card {
            flex: 1;
            background: radial-gradient(circle at top, #0b1120, #020617);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid #111827;
            position: relative;
            overflow: hidden;
        }

        .label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .value {
            font-size: 0.9rem;
            font-weight: 500;
            margin-top: 4px;
        }

        /* CIRCULAR LEVEL (plan view) */

        .circle-wrapper {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .circle {
            position: relative;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 2px solid #1d4ed8;
            background: radial-gradient(circle at center, #111827, #020617);
            box-shadow: 0 0 0 1px #0f172a, 0 0 40px rgba(59, 130, 246, 0.2);
        }

        .circle .crosshair {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 100%;
            height: 100%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .circle .crosshair::before,
        .circle .crosshair::after {
            content: "";
            position: absolute;
            left: 50%;
            top: 50%;
            background: rgba(148, 163, 184, 0.5);
        }

        .circle .crosshair::before {
            width: 1px;
            height: 100%;
            transform: translate(-50%, -50%);
        }

        .circle .crosshair::after {
            width: 100%;
            height: 1px;
            transform: translate(-50%, -50%);
        }

        .circle .dot {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #22c55e;
            background: rgba(22, 163, 74, 0.4);
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.7);
        }

        .circle .center-dot {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #64748b;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .heading {
            font-size: 0.75rem;
            margin-top: 4px;
            color: #a5b4fc;
        }

        /* VERTICAL LEVEL */

        .vertical-wrapper {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .vertical-bar {
            position: relative;
            width: 24px;
            height: 140px;
            border-radius: 999px;
            border: 2px solid #1d4ed8;
            background: linear-gradient(to bottom, #0b1120, #020617);
            overflow: hidden;
            box-shadow: 0 0 35px rgba(59, 130, 246, 0.25);
        }

        .vertical-bar-inner {
            position: absolute;
            inset: 4px;
            border-radius: inherit;
            background: linear-gradient(to bottom, #111827, #020617);
        }

        .vertical-bubble {
            position: absolute;
            left: 50%;
            width: 18px;
            height: 18px;
            border-radius: 999px;
            border: 2px solid #22c55e;
            background: rgba(22, 163, 74, 0.4);
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.7);
        }

        /* HORIZONTAL LEVEL */

        .horizontal-wrapper {
            margin-top: 6px;
        }

        .horizontal-bar {
            position: relative;
            height: 26px;
            width: 140px;
            justify-self: center;
            border-radius: 999px;
            border: 2px solid #1d4ed8;
            background: linear-gradient(to right, #0b1120, #020617);
            overflow: hidden;
            box-shadow: 0 0 35px rgba(59, 130, 246, 0.25);
        }

        .horizontal-bar-inner {
            position: absolute;
            inset: 4px;
            border-radius: inherit;
            background: linear-gradient(to right, #111827, #020617);
        }

        .horizontal-bubble {
            position: absolute;
            top: 50%;
            width: 18px;
            height: 18px;
            border-radius: 999px;
            border: 2px solid #22c55e;
            background: rgba(22, 163, 74, 0.4);
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.7);
        }

        /* ADDITIONAL ROTATIONS / DATA */

        .metrics {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 6px;
            margin-top: 4px;
            margin-bottom: 12px;
            font-size: 0.7rem;
        }

        .metric span {
            display: block;
        }

        .metric-label {
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-size: 0.65rem;
        }

        .metric-value {
            font-weight: 500;
            margin-top: 2px;
        }

        .status {
            font-size: 0.7rem;
            color: #f97316;
            margin-top: 4px;
            white-space: normal;
            overflow-wrap: break-word;
        }

        .greek {
            text-transform: lowercase;
        }

        @media (max-width: 380px) {
            .circle {
                width: 120px;
                height: 120px;
            }

            .vertical-bar {
                height: 120px;
            }
        }
    </style>
</head>
<body>
<div class="dashboard">
    <div class="header">
        <div>
            <h1>Phone spirit level</h1>
            <small>Uses DeviceOrientation + Motion</small>
        </div>
        <button id="enable-sensors">Enable sensors</button>
    </div>

    <!-- 1. LINE - VERTICAL + CIRCLE -->
    <div class="row">
        <!-- Vertical water level (beta) -->
        <div class="card" style="max-width: 120px;">
            <div class="label">Pitch (<span class="greek">β</span>)</div>
            <div class="vertical-wrapper">
                <div class="vertical-bar">
                    <div class="vertical-bar-inner"></div>
                    <div class="vertical-bubble" id="vertical-bubble"></div>
                </div>
            </div>
            <div class="value" id="beta-text">0.0°</div>
        </div>

        <!-- Circular water level (beta/gamma) -->
        <div class="card">
            <div class="label">Circular (ground plan)</div>
            <div class="circle-wrapper">
                <div class="circle">
                    <div class="crosshair"></div>
                    <div class="center-dot"></div>
                    <div class="dot" id="circle-dot"></div>
                </div>
            </div>
            <div class="heading" id="alpha-text">Azimuth: 0°</div>
            <div class="value" id="tilt-magnitude">Deviation: 0.0°</div>
        </div>
    </div>

    <!-- 2. LINE - HORIZONTAL + ROLL -->
    <div class="row">
        <div class="card" style="max-width: 120px;">
            <div class="label">Roll (<span class="greek">α</span>)</div>
            <div class="horizontal-bar" style="visibility: hidden;"></div>
            <div class="value" id="roll-text">0.0°</div>
        </div>

        <div class="card">
            <div class="label">Yaw (<span class="greek">γ</span>)</div>
            <div class="horizontal-wrapper">
                <div class="horizontal-bar">
                    <div class="horizontal-bar-inner"></div>
                    <div class="horizontal-bubble" id="horizontal-bubble"></div>
                </div>
            </div>
            <div class="value" id="gamma-text">0.0°</div>
        </div>
    </div>

    <!-- 3. LINE - ROTATION + ACCELERATION -->
    <div class="row">
        <div class="card">
            <div class="label">Rotation + Acceleration</div>
            <div class="metrics">
                <div class="metric">
                    <span class="metric-label"><span class="greek">α</span> rotation</span>
                    <span class="metric-value" id="rot-alpha">0.0°/s</span>
                </div>
                <div class="metric">
                    <span class="metric-label"><span class="greek">β</span> rotation</span>
                    <span class="metric-value" id="rot-beta">0.0°/s</span>
                </div>
                <div class="metric">
                    <span class="metric-label"><span class="greek">γ</span> rotation</span>
                    <span class="metric-value" id="rot-gamma">0.0°/s</span>
                </div>
                <div class="metric">
                    <span class="metric-label">acc X</span>
                    <span class="metric-value" id="acc-x">0.00 m/s²</span>
                </div>
                <div class="metric">
                    <span class="metric-label">acc Y</span>
                    <span class="metric-value" id="acc-y">0.00 m/s²</span>
                </div>
                <div class="metric">
                    <span class="metric-label">acc Z</span>
                    <span class="metric-value" id="acc-z">0.00 m/s²</span>
                </div>
            </div>
            <div class="status" id="device-text">
                Disconnected
            </div>
            <div class="status" id="status-text">
                Waiting for granting sensor access…
            </div>
        </div>
    </div>
</div>

<script>
    const enableButton = document.getElementById("enable-sensors");
    const statusText = document.getElementById("status-text");
    const deviceText = document.getElementById("device-text");

    const circleDot = document.getElementById("circle-dot");
    const verticalBubble = document.getElementById("vertical-bubble");
    const horizontalBubble = document.getElementById("horizontal-bubble");

    circleDot.style.left = "50%";
    circleDot.style.top = "50%";
    verticalBubble.style.top = "50%";
    horizontalBubble.style.left = "50%";

    const betaText = document.getElementById("beta-text");
    const gammaText = document.getElementById("gamma-text");
    const alphaText = document.getElementById("alpha-text");
    const tiltMagnitudeText = document.getElementById("tilt-magnitude");
    const rollText = document.getElementById("roll-text");

    const rotAlphaText = document.getElementById("rot-alpha");
    const rotBetaText = document.getElementById("rot-beta");
    const rotGammaText = document.getElementById("rot-gamma");
    const accXText = document.getElementById("acc-x");
    const accYText = document.getElementById("acc-y");
    const accZText = document.getElementById("acc-z");

    const circle = document.querySelector(".circle");
    const vBar = document.querySelector(".vertical-bar");
    const hBar = document.querySelector(".horizontal-bar");

    let sensorsEnabled = false;

    function clamp(value, min, max) {
        return Math.min(max, Math.max(min, value));
    }

    function handleOrientation(event) {
        if (!sensorsEnabled) return;

        let alpha = event.alpha || 0;   // compass / rotation around Z
        let beta = event.beta || 0;     // tilt forward/backward (-180, 180)
        let gamma = event.gamma || 0;   // tilt left/right (-90, 90)

        // Text values
        betaText.textContent = beta.toFixed(1) + "°";
        gammaText.textContent = gamma.toFixed(1) + "°";
        rollText.textContent = gamma.toFixed(1) + "°";
        alphaText.textContent = "Azimuth: " + alpha.toFixed(0) + "°";

        // Tilt magnitude (distance of the "bubble" from the center)
        const tiltMagnitude = Math.sqrt(beta * beta + gamma * gamma);
        tiltMagnitudeText.textContent =
            "Deviation: " + tiltMagnitude.toFixed(1) + "°";

        // 1) CIRCLE – beta/gamma mapping to X/Y
        const radius = (circle.clientWidth || 140) / 2 - 12; // the bubble didn't come out
        const maxTilt = 45; // at 45° the bubble ends on the edge

        const x = clamp((gamma / maxTilt) * radius, -radius, radius);
        const y = clamp((beta / maxTilt) * radius, -radius, radius);

        circleDot.style.left = 50 + (x / radius) * 50 + "%";
        circleDot.style.top = 50 + (y / radius) * 50 + "%";

        // 2) VERTICAL – the bubble moves up/down according to beta
        const vHeight = vBar.clientHeight || 140;
        const vRadius = vHeight / 2 - 10;
        const vY = clamp((beta / maxTilt) * vRadius, -vRadius, vRadius);
        const vPercent = 50 + (vY / vRadius) * 50;
        verticalBubble.style.top = vPercent + "%";

        // 3) HORIZONTAL – the bubble moves left/right according to gamma
        const hWidth = hBar.clientWidth || 140;
        const hRadius = hWidth / 2 - 10;
        const hX = clamp((gamma / maxTilt) * hRadius, -hRadius, hRadius);
        const hPercent = 50 + (hX / hRadius) * 50;
        horizontalBubble.style.left = hPercent + "%";

        // Highlighting the center with an almost perfect plane
        const within1deg = Math.abs(beta) < 1 && Math.abs(gamma) < 1;
        circleDot.style.borderColor = within1deg ? "#4ade80" : "#22c55e";
    }

    function handleMotion(event) {
        if (!sensorsEnabled) return;
        const rot = event.rotationRate || {};
        const acc = event.accelerationIncludingGravity || {};

        const rAlpha = rot.alpha || 0;
        const rBeta = rot.beta || 0;
        const rGamma = rot.gamma || 0;

        rotAlphaText.textContent = rAlpha.toFixed(1) + "°/s";
        rotBetaText.textContent = rBeta.toFixed(1) + "°/s";
        rotGammaText.textContent = rGamma.toFixed(1) + "°/s";

        const ax = acc.x || 0;
        const ay = acc.y || 0;
        const az = acc.z || 0;

        accXText.textContent = ax.toFixed(2) + " m/s²";
        accYText.textContent = ay.toFixed(2) + " m/s²";
        accZText.textContent = az.toFixed(2) + " m/s²";
    }

    async function requestSensors() {
        // iOS 13+ needs explicit requestPermission
        try {
            if (
                typeof DeviceOrientationEvent !== "undefined" &&
                typeof DeviceOrientationEvent.requestPermission === "function"
            ) {
                const response = await DeviceOrientationEvent.requestPermission();
                if (response !== "granted") {
                    statusText.textContent =
                        "Sensors denied. Check browser settings / HTTPS.";
                    return;
                }
            }
            // DeviceMotion has a similar mode on some iOS
            if (
                typeof DeviceMotionEvent !== "undefined" &&
                typeof DeviceMotionEvent.requestPermission === "function"
            ) {
                try {
                    await DeviceMotionEvent.requestPermission();
                } catch (e) {
                    // we ignore, it's not critical
                }
            }

            window.addEventListener("deviceorientation", handleOrientation, true);
            window.addEventListener("devicemotion", handleMotion, true);
            sensorsEnabled = true;
            statusText.textContent = "Sensors active.";
        } catch (err) {
            console.error(err);
            statusText.textContent =
                "Failed to activate sensors: " + err.message;
        }


        checkSensors().then(info => {
            const mobile = isMobileDevice();
            console.log("Sensor support:", info, "isMobile:", mobile);

            deviceText.textContent = mobile ?
                ("Phone" +
                    (navigator.platform ? " (" + navigator.platform + ")" : "") +
                    (navigator.userAgent ? " UA: " + navigator.userAgent : "") +
                    (navigator.vendor ? " Vendor: " + navigator.vendor : "") +
                    (navigator.appVersion ? " AppVer: " + navigator.appVersion : "") +
                    (navigator.hardwareConcurrency ? " CPU cores: " + navigator.hardwareConcurrency : "") +
                    (navigator.deviceMemory ? " RAM: " + navigator.deviceMemory + "GB" : "") +
                    (window.opera ? " Opera: " + window.opera.version() : "")) :
                ("Not a mobile device" +
                ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) ? " (touchscreen detected)" : "");

            if (!info?.orientationWorking) {
                document.body.style.background = '#370000';
                statusText.textContent = JSON.stringify(info).replaceAll(',"', ' ; "').replace('{', '').replace('}', '');
            } else {
                document.body.style.background = '#0F172A';
            }
        });
    }

    function isMobileDevice() {
        const ua = navigator.userAgent || navigator.vendor || window.opera;

        // rough mobile user agent detection
        const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);

        // touchscreen detection
        const hasTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        console.log("isMobileDevice check:", {isMobileUA, hasTouch});
        return isMobileUA && hasTouch;
    }


    async function checkSensors() {
        const support = {
            orientationAPI: !!window.DeviceOrientationEvent,
            motionAPI: !!window.DeviceMotionEvent,
            iOSPermission: false,
            permissionGranted: false,
            orientationWorking: false,
            motionWorking: false
        };

        // iOS – just checking the existence of the API, we don't call requestPermission without a user
        if (
            typeof DeviceOrientationEvent !== "undefined" &&
            typeof DeviceOrientationEvent.requestPermission === "function"
        ) {
            support.iOSPermission = true;
        }

        // Test whether the API actually returns data (without having to have permission right away)
        await new Promise((resolve) => {
            let timeout = setTimeout(resolve, 1000);

            function o(e) {
                if (e.alpha !== null || e.beta !== null || e.gamma !== null) {
                    support.orientationWorking = true;
                    window.removeEventListener("deviceorientation", o);
                    clearTimeout(timeout);
                    resolve();
                }
            }

            window.addEventListener("deviceorientation", o);

            function m(e) {
                if (e.acceleration || e.rotationRate) {
                    support.motionWorking = true;
                    window.removeEventListener("devicemotion", m);
                    clearTimeout(timeout);
                    resolve();
                }
            }

            window.addEventListener("devicemotion", m);
        });

        return support;
    }

    enableButton.addEventListener("click", requestSensors);
</script>
</body>
</html>
