<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Moira controller</title>

    <base href="./"/>

    <script>
        fetch("./shared-header.html")
            .then(res => res.text())
            .then(html => document.head.insertAdjacentHTML("beforeend", html));
    </script>
</head>
<body>
<noscript>
    <strong>We're sorry but Moira controller doesn't work properly without JavaScript enabled. Please enable it to
        continue.</strong>
</noscript>
<span id="errorInfo"></span>


<script>
    const logContainer = document.getElementById('errorInfo');


    async function loadManifest() {

        // let VERSION_PARAM = new URLSearchParams(window.location.search).get('version');

        let MOIRA_VERSION = null;

        try {
            const response = await fetch('./versions/manifest.json');
            if (!response.ok) {
                throw new Error('Manifest not found');
            } else {
                console.info('✅ Manifest loaded successfully.');
            }
            const manifestData = await response.json();


            if (!manifestData) {
                console.error('Manifest data is empty');
                return null;
            }
            if (!manifestData?.builds || !Array.isArray(manifestData?.builds)) {
                console.error('Invalid manifest format: "set" property is missing or not an array');
                return null;
            }

            let version = null
            const versionSet = manifestData?.set || [];
            const versionBuilds = manifestData?.builds || [];

            // Find label:'latest' version
            const latestVersion = versionSet.find(v => v.label === 'latest');
            if (latestVersion) {
                version = latestVersion.version;
            } else if (versionSet.length > 0) {
                // Fallback to the first version if 'latest' is not found
                version = versionSet[0].version;
            } else {
                console.error('No versions available in manifest');
            }

            if (version) {
                MOIRA_VERSION = versionBuilds.find(v => v.version === version);
            }

            if (version && !MOIRA_VERSION) {
                console.error(`Version ${version} not found in builds`);
            }

            if (!MOIRA_VERSION) {
                if (versionBuilds > 0) {
                    MOIRA_VERSION = versionBuilds[versionBuilds.length - 1].version;
                    console.warn(`Falling back to the latest available build: ${MOIRA_VERSION}`);
                } else {
                    console.error('No builds available in manifest');
                }
            }

            return MOIRA_VERSION;
        } catch (error) {
            console.warn('⚠️ Manifest not found!', error);
            logContainer.innerText = 'Manifest not found! Please make sure the manifest.json file is available.';
        }
    }

    async function changeVersion() {
        const version = await loadManifest();

        if (!version) {
            logContainer.innerText = 'No valid version found in manifest!';
            return;
        }

        let versionURL = version?.path

        if (!versionURL || typeof versionURL !== 'string' || versionURL.trim() === '') {
            console.error('Invalid version format:', version);
            logContainer.innerText = 'Invalid version format in manifest!';
            return;
        }

        versionURL = versionURL.trim().replace(/^\//, ''); // Remove leading slash if present

        if (!versionURL.endsWith('/') && !versionURL.endsWith('.html')) {
            versionURL += '/'; // Ensure it ends with a slash
        }
        if (versionURL.startsWith('/')) {
            versionURL = '.' + versionURL;
        }
        if (!versionURL.startsWith('./')) {
            versionURL = './' + versionURL;
        }
        if (!versionURL.startsWith('./versions/')) {
            versionURL = `./versions/${versionURL}`;
        }

        if (window.location.href.includes(versionURL)) {
            console.log('✅ Already on the latest version:', version);
            return;
        }

        if (window.location.href.includes('/versions/')) {
            console.log('ℹ️ Redirecting from another version to the latest version:', version);
        } else {
            console.log('ℹ️ Redirecting to the latest version:', version);
        }

        // if (window.location.href.includes('?')) {
        //     console.log('ℹ️ Preserving query parameters during redirect.');
        //     const queryParams = window.location.href.split('?')[1];
        //     window.location.href = `./versions/${version}?${queryParams}`;
        //     return;
        // }
        //
        // if (window.location.href.includes('#')) {
        //     console.log('ℹ️ Preserving hash fragment during redirect.');
        //     const hashFragment = window.location.href.split('#')[1];
        //     window.location.href = `./versions/${version}#${hashFragment}`;
        //     return;
        // }
        //
        // if (window.location.href.includes('?') && window.location.href.includes('#')) {
        //     console.log('ℹ️ Preserving both query parameters and hash fragment during redirect.');
        //     const queryParams = window.location.href.split('?')[1].split('#')[0];
        //     const hashFragment = window.location.href.split('#')[1];
        //     window.location.href = `./versions/${version}?${queryParams}#${hashFragment}`;
        //     return;
        // }


        console.log('➡️ Redirecting to version:', version, versionURL);
        window.location.href = versionURL;

    }


    changeVersion();
</script>
</body>
</html>